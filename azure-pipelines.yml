# Maven
# Build your Java project and run tests with Apache Maven.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/java

trigger:
- main

#pool:
#  vmImage: ubuntu-latest
  
variables:
  imageName: 'rcmendes/quarkus-redis'
  serviceConnection: 'quayServiceConnection'  

stages:
- stage: 'CI'
  displayName: 'Build and Push Image'
  jobs:
  - job: 'Build'
    displayName: 'Build and Push Image'
    pool:
      vmImage: ubuntu-latest
    steps:
      
    - task: Maven@3
      inputs:
        options: '-DskipTests' 
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: '17'
        jdkArchitectureOption: 'x64'
        goals: 'package'

    - task: Docker@2
      displayName: Build from Red Hat Universal Base Image
      inputs:
        command: buildAndPush
        containerRegistry: $(serviceConnection)
        repository: $(imageName)
        Dockerfile: src/main/docker/Dockerfile.jvm
        buildContext: $(System.DefaultWorkingDirectory)
        tags: $(Build.SourceVersion)
- stage: 'CD'
  displayName: "Update the manifest repo"
  dependsOn: 'CI'
  jobs:
  - job: 'CI'
    displayName: 'Update manifest repo'
    pool: 
      vmImage: ubuntu-latest
    steps:
    
    - script: 'git clone https://github.com/raffamendes/helm-charts.git'
      displayName: 'Updating helm repo'
